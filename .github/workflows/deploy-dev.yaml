name: Auto Deploy Next.js (Dev)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env.development.local
        run: |
          cat > .env.development.local << EOF
          SESSION_SECRET=${{ secrets.SESSION_SECRET }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          APP_URL=${{ secrets.APP_URL }}
          NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID=${{ secrets.NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID }}
          NODE_ENV=development
          EOF

      - name: Migrate Prisma
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma migrate deploy && npx prisma generate

      - name: Build Next.js
        env:
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          APP_URL: ${{ secrets.APP_URL }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID }}
        run: NEXT_IGNORE_ESLINT_DURING_BUILD=1 npm run build

      - name: Restart Next.js app
        run: |
          if npx pm2 describe nextjs-app > /dev/null 2>&1; then
            npx pm2 reload nextjs-app
          else
            npx pm2 start node_modules/.bin/next --name "nextjs-app" --interpreter node -- start
          fi
          npx pm2 save

      - name: Generate commit messages list
        id: commits
        run: |
          echo "COMMITS=$(git log ${{ github.event.before }}..${{ github.sha }} --pretty=format:'‚Ä¢ %s (%an)' | tr '\n' '\r')" >> $GITHUB_ENV

      - name: Notify Telegram (Success)
        if: success()
        run: |
          TEXT=$(cat <<'EOF'
          ‚úÖ *Deploy Success!*
          
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          By: ${{ github.actor }}
          
          *Commits:*
          ${{ env.COMMITS }}
          
          üß© [View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )
          TEXT_URLENCODED=$(echo "$TEXT" | jq -s -R -r @uri)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_TOPIC_ID }}" \
            -d text="$TEXT_URLENCODED" \
            -d parse_mode="Markdown"

      - name: Notify Telegram (Failed)
        if: failure()
        run: |
          PM2_LOGS=$(npx pm2 logs nextjs-app --lines 15 --nostream 2>&1 | head -c 600 || echo "No logs")
          TEXT="‚ùå *Deploy Failed!*

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          By: ${{ github.actor }}

          *Last Logs:*
          \`\`\`
          ${PM2_LOGS}
          \`\`\`

          üß© [View Full Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          TEXT_URLENCODED=$(echo "$TEXT" | jq -s -R -r @uri)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_TOPIC_ID }}" \
            -d text="$TEXT_URLENCODED" \
            -d parse_mode="Markdown" || true