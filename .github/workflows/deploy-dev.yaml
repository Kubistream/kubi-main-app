name: Auto Deploy Next.js (Dev)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          npm install

      - name: Build Next.js
        run: |
          npm run build

      - name: Restart Next.js app
        run: |
          pm2 reload nextjs-app || pm2 start npm --name "nextjs-app" -- start

      - name: Generate commit messages list
        id: commits
        run: |
          echo "COMMITS=$(git log ${{ github.event.before }}..${{ github.sha }} --pretty=format:'â€¢ %s (%an)' | tr '\n' '\r')" >> $GITHUB_ENV

      - name: Notify Telegram (Success)
        if: success()
        run: |
          TEXT=$(cat <<EOF
âœ… *Deploy Success!*
Repository: ${{ github.repository }}
Branch: ${{ github.ref_name }}
By: ${{ github.actor }}

*Commits:*
${{ env.COMMITS }}

ðŸ§© [View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
EOF
)
          TEXT_URLENCODED=$(echo "$TEXT" | jq -s -R -r @uri)

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_TOPIC_ID }}" \
            -d text="$TEXT_URLENCODED" \
            -d parse_mode="Markdown"

      - name: Notify Telegram (Failed)
        if: failure()
        run: |
          TEXT=$(cat <<EOF
âŒ *Deploy Failed!*
Repository: ${{ github.repository }}
Branch: ${{ github.ref_name }}
By: ${{ github.actor }}

ðŸ§© [View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
EOF
)
          TEXT_URLENCODED=$(echo "$TEXT" | jq -s -R -r @uri)

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_TOPIC_ID }}" \
            -d text="$TEXT_URLENCODED" \
            -d parse_mode="Markdown"
